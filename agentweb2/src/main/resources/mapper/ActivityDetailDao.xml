<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.eeepay.framework.dao.ActivityDetailDao" >

    <sql id="commonWhere">
        WHERE ai.agent_node like concat(#{currentAgentNo}, '%')
        <if test="bean != null">
            <if test="bean.merchantNo != null and bean.merchantNo != ''">
                AND (uc.merchant_no = #{bean.merchantNo} OR POSITION(#{bean.merchantNo} IN mi.merchant_name) > 0)
            </if>
            <if test="bean.startTime != null and bean.startTime != ''">
                AND uc.start_time &gt;= CONCAT(#{bean.startTime},' 00:00:00')
            </if>
            <if test="bean.endTime != null and bean.endTime != ''">
                AND uc.start_time &lt;= CONCAT(#{bean.endTime},' 23:59:59')
            </if>
            <if test="bean.agentNo != null and bean.agentNo != ''">
                AND ai.agent_node like concat(#{bean.agentNo}, '%')
            </if>
            <if test="bean.couponNo != null and bean.couponNo != ''">
                AND uc.coupon_no = #{bean.couponNo }
            </if>
            <if test="bean.couponCode != null and bean.couponCode != ''">
                AND uc.coupon_code = #{bean.couponCode }
            </if>
            <if test="bean.mobilephone != null and bean.mobilephone != ''">
                AND mi.mobilephone = #{bean.mobilephone}
            </if>
        </if>
    </sql>

    <select id="listUserCouponsByPage" resultType="cn.eeepay.framework.model.UserCouponBean">
        SELECT uc.id,
            uc.merchant_no,mi.merchant_name,mi.mobilephone,
            ai.agent_name,ai.agent_no,
            uc.face_value,
            IF(DATEDIFF(uc.end_time, CURRENT_DATE) &lt; 0 || uc.coupon_status = 4, 0, uc.balance) as balance,
            IF(DATEDIFF(uc.end_time, CURRENT_DATE) &lt; 0 || uc.coupon_status = 4, uc.balance, 0) as overdueMoney,
            uc.face_value - uc.balance AS usedMoney,
            uc.cancel_verification_code,uc.coupon_no,
            uc.coupon_status,uc.coupon_code,uc.token,
            DATE_FORMAT(uc.start_time, '%Y-%m-%d') AS start_time,
            DATE_FORMAT(uc.end_time, '%Y-%m-%d') AS end_time
        FROM user_coupon uc
        LEFT JOIN merchant_info mi ON mi.merchant_no = uc.merchant_no
        LEFT JOIN agent_info ai ON ai.agent_node = mi.parent_node
        <include refid="commonWhere"/>
    </select>
    <select id="countUserCoupons" resultType="cn.eeepay.framework.model.UserCouponBean">
        SELECT
            IFNULL(SUM(uc.face_value),0)                            AS face_value,
            IFNULL(SUM(IF(DATEDIFF(uc.end_time, CURRENT_DATE) &lt; 0 || uc.coupon_status = 4, 0, uc.balance)),0)   AS balance,
            IFNULL(SUM(uc.face_value) - SUM(uc.balance),0) 	      AS usedMoney,
            IFNULL(SUM(IF(DATEDIFF(uc.end_time, CURRENT_DATE) &lt; 0 || uc.coupon_status = 4, uc.balance, 0)),0)  AS overdueMoney
        FROM user_coupon uc
        LEFT JOIN merchant_info mi ON mi.merchant_no = uc.merchant_no
        LEFT JOIN agent_info ai ON ai.agent_node = mi.parent_node
        <include refid="commonWhere"/>
    </select>


    <select id="listMerchantIncome" resultType="cn.eeepay.framework.model.MerchantIncomeBean">
        SELECT
            cpp.id,
            mi.merchant_name,
            mi.merchant_no,
            mi.mobilephone,
            cpp.trans_amount,
            cpp.trans_fee,
            cpp.discount_fee,
            cpp.merchant_profit,
            cpp.activity_code,
            cpp.order_no,
            cpp.create_time
        FROM cloud_pay_profit cpp
        JOIN merchant_info mi ON mi.merchant_no = cpp.merchant_no
        WHERE mi.parent_node LIKE CONCAT(#{bean.loginAgentNode}, '%')
        <if test="bean.merchantNo != null and bean.merchantNo != ''">
            AND mi.merchant_no = #{bean.merchantNo}
        </if>
        <if test="bean.merchantName != null and bean.merchantName != ''">
            AND position(#{bean.merchantName} IN mi.merchant_name)
        </if>
        <if test="bean.mobilephone != null and bean.mobilephone != ''">
            AND mi.mobilephone = #{bean.mobilephone}
        </if>
        <if test="bean.startCreateTime != null and bean.startCreateTime != ''">
            AND cpp.create_time >= #{bean.startCreateTime}
        </if>
        <if test="bean.endCreateTime != null and bean.endCreateTime != ''">
            AND cpp.create_time &lt;= #{bean.endCreateTime}
        </if>
        <if test="bean.minTransAmount != null and bean.minTransAmount != ''">
            AND cpp.trans_amount >= #{bean.minTransAmount}
        </if>
        <if test="bean.maxTransAmount != null and bean.maxTransAmount != ''">
            AND cpp.trans_amount &lt;= #{bean.maxTransAmount}
        </if>
        <if test="bean.minMerchantProfit != null and bean.minMerchantProfit != ''">
            AND cpp.merchant_profit >= #{bean.minMerchantProfit}
        </if>
        <if test="bean.maxMerchantProfit != null and bean.maxMerchantProfit != ''">
            AND cpp.merchant_profit &lt;= #{bean.maxMerchantProfit}
        </if>
        <if test="bean.orderNo != null and bean.orderNo != ''">
            AND cpp.order_no = #{bean.orderNo}
        </if>
        <if test="bean.activityCode != null and bean.activityCode != ''">
            AND cpp.activity_code = #{bean.activityCode}
        </if>
    </select>
</mapper>
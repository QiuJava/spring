<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.eeepay.framework.dao.RedemProviderDao" >

    <select id="listProvider" resultType="cn.eeepay.framework.model.redemActive.RedemProviderBean">
        SELECT
              ai.agent_no, ai.agent_name,rasc.share_rate,rasc.oem_fee, ai.parent_id,
              rasc.receive_share_rate,
              rasc.repayment_share_rate
        FROM agent_info ai
            LEFT JOIN rdmp_agent_share_config rasc ON rasc.agent_no = ai.agent_no
        WHERE ai.agent_node like concat(#{loginAgent.agentNode}, '%')
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.agentNo)">
          and ai.agent_no = #{bean.agentNo}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.agentName)">
            and position(#{bean.agentName} in ai.agent_name)
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.mobilephone)">
            and ai.mobilephone = #{bean.mobilephone}
        </if>
    </select>

    <select id="queryRedemActiveCost" resultType="cn.eeepay.framework.model.redemActive.RedemProviderBean">
        SELECT agent_no, share_rate, oem_fee FROM rdmp_agent_share_config
        WHERE agent_no = #{agentNo}
    </select>

    <select id="chechAgentNoIsDirectChildren" resultType="int">
        SELECT count(*) FROM agent_info ai
        LEFT JOIN rdmp_agent_share_config rasc ON rasc.agent_no = ai.agent_no
        WHERE ai.parent_id = #{loginAgent.agentNo}
        AND ai.agent_no in
        <foreach collection="list" item="item" open="(" close=")" separator=",">
          #{item}
        </foreach>
        AND IFNULL(rasc.share_rate, '') = ''
    </select>

    <insert id="openRedemActive">
        REPLACE INTO rdmp_agent_share_config(agent_no, share_rate, oem_fee, share_type, create_time)
        VALUE
        <foreach collection="list" item="item" separator=",">
            (#{item.agentNo}, #{item.shareRate}, #{item.oemFee}, 'D', now())
        </foreach>
    </insert>
    <update id="updateServiceCost">
        update rdmp_agent_share_config
        set share_rate = #{bean.shareRate},
            oem_fee = #{bean.oemFee},
            receive_share_rate = #{bean.receiveShareRate},
            repayment_share_rate = #{bean.repaymentShareRate}
        where agent_no = #{bean.agentNo}
        and share_type = 'D'
    </update>

    <select id="queryChildrenMaxRedemActiveCost"  resultType="cn.eeepay.framework.model.redemActive.RedemProviderBean">
        SELECT MAX(share_rate) share_rate,MAX(oem_fee) oem_fee FROM rdmp_agent_share_config rgsc
        WHERE EXISTS(
                SELECT 1 FROM agent_info ai
                WHERE ai.agent_node LIKE CONCAT(#{agentNode}, '_%')
                      AND rgsc.agent_no = ai.agent_no
        )
    </select>
</mapper>
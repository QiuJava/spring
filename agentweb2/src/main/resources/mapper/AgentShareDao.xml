<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.eeepay.framework.dao.AgentShareDao" >
    <select id="queryMemberBpId" resultType="long">
        SELECT bpg2.bp_id
        FROM agent_share_rule asr
        LEFT JOIN business_product_info b ON b.service_id = asr.service_id
        LEFT JOIN business_product_group bpg ON b.bp_id = bpg.bp_id
        JOIN business_product_group bpg2 ON bpg2.group_no = bpg.group_no
        LEFT JOIN business_product_define bpd ON bpd.bp_id = bpg2.bp_id
        WHERE asr.id = #{shareId}
        AND bpd.allow_individual_apply = 0
        AND bpd.effective_status = 1
    </select>
    <insert id="insertAgentShareListTask" useGeneratedKeys="true" keyProperty="agent.id" parameterType="cn.eeepay.framework.model.AgentShareRuleTask">
        insert into agent_share_rule_task(share_id,efficient_date,effective_status,profit_type,per_fix_income,
        per_fix_inrate,safe_line,capping,share_profit_percent, ladder,cost_rate_type,per_fix_cost,cost_rate,
        cost_capping,cost_safeline,ladder1_rate,ladder1_max,ladder2_rate,ladder2_max,ladder3_rate,
        ladder3_max,ladder4_rate,ladder4_max,check_status) values(#{agent.shareId},#{agent.efficientDate},0,
        #{agent.profitType},#{agent.perFixIncome},#{agent.perFixInrate},
        #{agent.safeLine},#{agent.capping},#{agent.shareProfitPercent},#{agent.ladder},#{agent.costRateType},
        #{agent.perFixCost},#{agent.costRate},#{agent.costCapping},#{agent.costSafeline},
        #{agent.ladder1Rate},#{agent.ladder1Max},#{agent.ladder2Rate},#{agent.ladder2Max},#{agent.ladder3Rate},
        #{agent.ladder3Max},#{agent.ladder4Rate},#{agent.ladder4Max},#{agent.checkStatus})
    </insert>
    <select id="getMemberShareId" resultType="long">
        SELECT main.id FROM
        (
            SELECT
            CONCAT(si.service_type,IFNULL(si2.service_type,'')) AS service_type,asr.*
            FROM business_product_info bpi
            LEFT JOIN agent_share_rule asr ON bpi.service_id = asr.service_id
            LEFT JOIN service_info si ON asr.service_id = si.service_id
            LEFT JOIN service_info si2 ON si2.link_service = si.service_id
            WHERE bpi.bp_id=#{memberBpId}
            and si.effective_status = 1
        )main
        JOIN
        (
            SELECT CONCAT(si.service_type,IFNULL(si2.service_type,'')) AS service_type,asr.*
             FROM agent_share_rule asr
            LEFT JOIN business_product_info bpi ON bpi.service_id = asr.service_id
            LEFT JOIN service_info si ON asr.service_id = si.service_id
            LEFT JOIN service_info si2 ON si2.link_service = si.service_id
            WHERE asr.id = #{leaderShareId}
        )sub ON main.agent_no = sub.agent_no
            AND main.card_type = sub.card_type
            AND main.holidays_mark = sub.holidays_mark
            AND main.service_type = sub.service_type
    </select>
    <select id="getMemberAgentShareTaskId" resultType="int">
        SELECT id FROM agent_share_rule_task asrt
        WHERE asrt.share_id = #{memberShareId}
        AND EXISTS (
            SELECT 1 FROM agent_share_rule_task asrt2
            WHERE asrt.efficient_date = asrt2.`efficient_date`
            AND asrt2.id = #{leaderId}
        )
        limit 1
    </select>

    <insert id="insertShareUpdateRecord" parameterType="cn.eeepay.framework.model.ProfitUpdateRecord" >
        insert into profit_update_record (share_id,cost_history,cost,share_profit_percent_history,
        share_profit_percent,efficient_date,effective_status,update_date,auther,share_task_id)
        values (#{record.shareId},#{record.costHistory},#{record.cost},#{record.shareProfitPercentHistory},
        #{record.shareProfitPercent},#{record.efficientDate},#{record.effectiveStatus},now(),#{record.auther},
        #{record.shareTaskId})
    </insert>

    <select id="selectByShareId" resultType="cn.eeepay.framework.model.AgentShareRule">
        select * from agent_share_rule where id = #{shareId}
    </select>
    <select id="queryAgentShareListTaskByEfficientDate" resultType="int">
        select count(1) FROM agent_share_rule_task asrt
        where asrt.share_id = #{shareId}
        and asrt.efficient_date = #{efficientDate}
    </select>

    <select id="getSameTypeParentAgentShare" resultType="cn.eeepay.framework.model.AgentShareRule">
        SELECT
            asr1.*,si.service_name,bpd.bp_name
        FROM agent_share_rule asr1
        LEFT JOIN service_info si on asr1.service_id=si.service_id
	    LEFT JOIN business_product_info bpi ON bpi.service_id = si.service_id
        LEFT JOIN business_product_group bpg ON bpg.bp_id = bpi.bp_id
        LEFT JOIN business_product_define bpd ON bpd.bp_id = bpi.bp_id
        JOIN agent_share_rule asr2 ON asr2.service_id = asr1.service_id
            AND asr2.card_type = asr1.card_type
            AND asr2.holidays_mark = asr1.holidays_mark
            AND asr1.agent_no = (SELECT parent_id FROM agent_info ai WHERE ai.agent_no = asr2.agent_no)
        WHERE   asr2.id =  #{shareId}
        limit 1
    </select>
    <select id="findAgentNo" resultType="string">
        select agent_no from agent_share_rule where id = #{shareId}
    </select>
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.eeepay.framework.dao.InvitePrizesMerchantDao" >

    <select id="listInvitePrizesMerchant"  resultType="cn.eeepay.framework.model.InvitePrizesMerchantBean">
        SELECT
            ipmi.id,ipmi.merchant_no, ipmi.agent_node,
            ipmi.prizes_amount,ipmi.account_status,
            ipmi.account_time,ipmi.create_time,ipmi.update_time,
            ipmi.operator,ipmi.order_no,
            mi.merchant_name,ai.agent_name,ai.agent_no
        FROM invite_prizes_merchant_info  ipmi
        LEFT JOIN merchant_info mi ON mi.merchant_no = ipmi.merchant_no
        LEFT JOIN agent_info ai ON ai.agent_node = ipmi.agent_node
        <include refid="commonWhere"/>
        order BY ipmi.create_time desc
    </select>

    <select id="countInvitePrizesMerchant" resultType="map">
        SELECT
            SUM(ipmi.prizes_amount) sumAmount,
            SUM(IF(ipmi.account_status=0,ipmi.prizes_amount, 0)) unrecordedAmount,
            SUM(IF(ipmi.account_status=1,ipmi.prizes_amount, 0)) recordedAmount
        FROM invite_prizes_merchant_info  ipmi
        LEFT JOIN merchant_info mi ON mi.merchant_no = ipmi.merchant_no
        LEFT JOIN agent_info ai ON ai.agent_node = ipmi.agent_node

        <include refid="commonWhere"/>
    </select>
    <sql id="commonWhere">
        <where>
            ipmi.agent_node like CONCAT(#{loginAgentNode}, '%')
            and ipmi.prizes_type = '2'
            <if test="bean.merchantNo != null and bean.merchantNo != ''">
                AND ipmi.merchant_no = #{bean.merchantNo}
            </if>
            <if test="bean.agentNode != null and bean.agentNode != ''">
                <if test="bean.containSub == '1'.toString()">
                    AND ipmi.agent_node like CONCAT(#{bean.agentNode}, '%')
                </if>
                <if test="bean.containSub != '1'.toString()">
                    AND ipmi.agent_node = #{bean.agentNode}
                </if>
            </if>
            <if test="bean.accountStatus != null and bean.accountStatus != ''">
                AND ipmi.account_status = #{bean.accountStatus}
            </if>
            <if test="bean.startCreateTime != null and bean.startCreateTime != ''">
                AND ipmi.create_time >= #{bean.startCreateTime}
            </if>
            <if test="bean.endCreateTime != null and bean.endCreateTime != ''">
                AND ipmi.create_time &lt;= #{bean.endCreateTime}
            </if>
        </where>
    </sql>
</mapper>














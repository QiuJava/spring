<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.eeepay.framework.daoRedem.redemActive.RedemActiveOrderDao" >

    <select id="listDeclareOrder" resultType="cn.eeepay.framework.model.redemActive.RedemActiveOrderBean">
        SELECT
            yo.order_no,
            yo.order_status,
            ifnull(yo.oem_share, 0) oem_share,
            ydo.org_code,
            yoi.org_name,
            ymi.merchant_no,
            ymi.user_name,
            ymi.mobile_username mobile,
            ydo.price amount,
            DATE_FORMAT(ydo.create_time,'%Y-%m-%d %H:%i:%s') create_time,
            yo.acc_status,
            ydo.receive_status,
            ydo.check_status,
            DATE_FORMAT(ydo.check_time,'%Y-%m-%d %H:%i:%s') check_time,
            ydo.check_oper
        FROM yfb_order yo
        JOIN yfb_declare_order ydo ON ydo.order_no = yo.order_no AND yo.order_type = 'D'
        JOIN yfb_merchant_info ymi ON ymi.merchant_no = ydo.mer_no
        JOIN yfb_org_info yoi ON yoi.org_code = ydo.org_code
        <include refid="declareOrderCommonWhere"/>
        ORDER BY ydo.create_time desc
    </select>

    <select id="countDeclareOrder" resultType="cn.eeepay.framework.model.redemActive.RedemActiveOrderBean">
        SELECT
            ifnull(sum(yo.oem_share), 0) oem_share,
            ifnull(sum(ydo.price), 0) amount
        FROM yfb_order yo
        JOIN yfb_declare_order ydo ON ydo.order_no = yo.order_no AND yo.order_type = 'D'
        JOIN yfb_merchant_info ymi ON ymi.merchant_no = ydo.mer_no
        JOIN yfb_org_info yoi ON yoi.org_code = ydo.org_code
        <include refid="declareOrderCommonWhere"/>
    </select>

    <sql id="declareOrderCommonWhere">
        WHERE ymi.agent_node LIKE CONCAT (#{loginAgent.agentNode}, '%')
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.orderNo)">
            AND yo.order_no = #{bean.orderNo}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.checkStatus)">
            AND ydo.check_status = #{bean.checkStatus}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.orgCode)">
            AND ydo.org_code = #{bean.orgCode}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.merchantNo)">
            AND ymi.merchant_no = #{bean.merchantNo}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.mobile)">
            AND ymi.mobile_username = #{bean.mobile}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.userName)">
            AND ymi.user_name like concat('%', #{bean.userName} ,'%')
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.createTimeStart)">
            AND ydo.create_time >= #{bean.createTimeStart}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.createTimeEnd)">
            AND ydo.create_time &lt;= #{bean.createTimeEnd}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.checkTimeStart)">
            AND ydo.check_time >= #{bean.checkTimeStart}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.checkTimeEnd)">
            AND ydo.check_time &lt;= #{bean.checkTimeEnd}
        </if>
    </sql>

    <select id="listShareOrder" resultType="cn.eeepay.framework.model.redemActive.RedemActiveOrderBean">
        SELECT
            yasd.order_no,
            yasd.mer_no merchantNo,
            ymi.user_name,
            ymi.mobile_username mobile,
            yasd.share_type orderType,
            yasd.share_amount,
            yasd.agent_no,
            yasd.acc_status,
            yasd.agent_node,
            yasd.amount,
            DATE_FORMAT(yasd.create_time,'%Y-%m-%d %H:%i:%s') create_time
        FROM yfb_agent_share_detail yasd
        JOIN yfb_merchant_info ymi ON yasd.mer_no = ymi.merchant_no
        WHERE yasd.agent_node LIKE CONCAT (#{loginAgent.agentNode}, '%')
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.agentNode)">
            AND yasd.agent_node LIKE CONCAT (#{bean.agentNode}, '%')
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.orderNo)">
            AND yasd.order_no = #{bean.orderNo}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.orderType)">
            AND yasd.share_type = #{bean.orderType}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.createTimeStart)">
            AND yasd.create_time >= #{bean.createTimeStart}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.createTimeEnd)">
            AND yasd.create_time &lt;= #{bean.createTimeEnd}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.accStatus)">
            AND yasd.acc_status = #{bean.accStatus}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.merchantNo)">
            AND ymi.merchant_no = #{bean.merchantNo}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.mobile)">
            AND ymi.mobile_username = #{bean.mobile}
        </if>
        order by yasd.create_time desc
    </select>

    <select id="listOrgCode" resultType="map">
        SELECT * FROM yfb_org_info
    </select>


    <select id="listRepayOrder" resultType="cn.eeepay.framework.model.redemActive.RedemActiveOrderBean">
        SELECT
            yo.order_no,
            yo.order_status,
            aro.repay_status,
            ymi.merchant_no,
            ymi.user_name,
            ymi.mobile_username mobile,
            ymi.repay_merchant_no,
            aro.source_order_no,
            aro.plan_amount,
            aro.actual_amount,
            aro.rate,
            DATE_FORMAT(aro.create_time,'%Y-%m-%d %H:%i:%s') create_time,
            DATE_FORMAT(aro.completion_time,'%Y-%m-%d %H:%i:%s') completion_time,
            ymi.agent_no,
            IFNULL(yo.oem_share, 0) oem_share,
            yo.acc_status
        FROM yfb_order yo
        JOIN act_repay_order aro ON aro.order_no = yo.order_no AND yo.order_type = 'R'
        JOIN yfb_merchant_info ymi ON ymi.merchant_no = aro.mer_no
        <include refid="repayOrderCommonWhere"/>
        ORDER BY aro.create_time DESC
    </select>

    <select id="countRepayOrder" resultType="cn.eeepay.framework.model.redemActive.RedemActiveOrderBean">
        SELECT
            ifnull(sum(yo.oem_share), 0) oem_share,
            ifnull(sum(aro.plan_amount), 0) plan_amount,
            ifnull(sum(aro.actual_amount), 0) actual_amount
        FROM yfb_order yo
        JOIN act_repay_order aro ON aro.order_no = yo.order_no AND yo.order_type = 'R'
        JOIN yfb_merchant_info ymi ON ymi.merchant_no = aro.mer_no
        <include refid="repayOrderCommonWhere"/>
    </select>

    <sql id="repayOrderCommonWhere">
        WHERE ymi.agent_node LIKE CONCAT (#{loginAgent.agentNode}, '%')
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.agentNode)">
            AND ymi.agent_node LIKE CONCAT (#{bean.agentNode}, '%')
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.orderNo)">
            AND yo.order_no = #{bean.orderNo}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.sourceOrderNo)">
            AND aro.source_order_no = #{bean.sourceOrderNo}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.orderStatus)">
            AND yo.order_status = #{bean.orderStatus}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.merchantNo)">
            AND ymi.merchant_no = #{bean.merchantNo}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.repayMerchantNo)">
            AND ymi.repay_merchant_no = #{bean.repayMerchantNo}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.mobile)">
            AND ymi.mobile_username = #{bean.mobile}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.repayStatus)">
            AND aro.repay_status = #{bean.repayStatus}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.accStatus)">
            AND yo.acc_status = #{bean.accStatus}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.createTimeStart)">
            AND aro.create_time >= #{bean.createTimeStart}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.createTimeEnd)">
            AND aro.create_time &lt;= #{bean.createTimeEnd}
        </if>
    </sql>


    <select id="listReceiveOrder" resultType="cn.eeepay.framework.model.redemActive.RedemActiveOrderBean">
        SELECT
            yo.order_no,
            yo.order_status,
            ymi.merchant_no,
            ymi.user_name,
            ymi.mobile_username mobile,
            armi.receive_merchant_no,
            aro.source_order_no,
            aro.pay_method,
            aro.amount,
            aro.rate,
            yo.provide_amout,
            DATE_FORMAT(aro.create_time,'%Y-%m-%d %H:%i:%s') create_time,
            ymi.agent_no,
            IFNULL(yo.oem_share, 0) oem_share,
            yo.acc_status
        FROM yfb_order yo
        JOIN act_receive_order aro ON aro.order_no = yo.order_no AND yo.order_type = 'O'
        JOIN yfb_merchant_info ymi ON ymi.merchant_no = aro.mer_no
        JOIN act_receive_merchant_info armi ON armi.source_merchant_no = ymi.merchant_no
        <include refid="receiveOrderCommonWhere"/>
        ORDER BY aro.create_time DESC
    </select>

    <select id="countReceiveOrder" resultType="cn.eeepay.framework.model.redemActive.RedemActiveOrderBean">
        SELECT
            ifnull(sum(aro.amount),0) amount,
            IFNULL(sum(yo.oem_share), 0) oem_share
        FROM yfb_order yo
        JOIN act_receive_order aro ON aro.order_no = yo.order_no AND yo.order_type = 'O'
        JOIN yfb_merchant_info ymi ON ymi.merchant_no = aro.mer_no
        JOIN act_receive_merchant_info armi ON armi.source_merchant_no = ymi.merchant_no
        <include refid="receiveOrderCommonWhere"/>
    </select>

    <sql id="receiveOrderCommonWhere">
        WHERE ymi.agent_node LIKE CONCAT (#{loginAgent.agentNode}, '%')
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.agentNode)">
            AND ymi.agent_node LIKE CONCAT (#{bean.agentNode}, '%')
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.orderNo)">
            AND yo.order_no = #{bean.orderNo}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.sourceOrderNo)">
            AND aro.source_order_no = #{bean.sourceOrderNo}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.orderStatus)">
            AND yo.order_status = #{bean.orderStatus}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.merchantNo)">
            AND ymi.merchant_no = #{bean.merchantNo}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.receiveMerchantNo)">
            AND armi.receive_merchant_no = #{bean.receiveMerchantNo}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.mobile)">
            AND ymi.mobile_username = #{bean.mobile}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.accStatus)">
            AND yo.acc_status = #{bean.accStatus}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.payMethod)">
            AND aro.pay_method = #{bean.payMethod}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.createTimeStart)">
            AND aro.create_time >= #{bean.createTimeStart}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(bean.createTimeEnd)">
            AND aro.create_time &lt;= #{bean.createTimeEnd}
        </if>
    </sql>
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.eeepay.framework.dao.AgentFunctionDao" >


    <select id="listAgentFunction" resultType="cn.eeepay.framework.model.AgentFunctionBean">
        SELECT
            afr.function_number,
            afr.function_name,
            IF(afc.agent_no IS NULL, afr.function_default_value, '1') function_value
        FROM agent_function_rule afr
        LEFT JOIN agent_function_config afc ON  afc.function_number = afr.function_number AND afc.agent_no = #{loginAgentNo}
    </select>
    
    <select id="selectAgentFunction" resultType="cn.eeepay.framework.model.AgentFunctionBean">
        SELECT
            afr.function_number,
            afr.function_name,
            IF(afc.agent_no IS NULL, afr.function_default_value, '1') function_value
        FROM agent_function_rule afr
        LEFT JOIN agent_function_config afc ON  afc.function_number = afr.function_number AND afc.agent_no = #{loginAgentNo}
        WHERE afr.function_number != '002' AND afr.function_number != '003'
    </select>

    <select id="queryFunctionById" resultType="cn.eeepay.framework.model.AgentFunctionBean">
        SELECT
            afr.function_number,
            afr.function_name
        FROM agent_function_rule afr
        WHERE afr.function_number = #{functionNumber}
    </select>

    <update id="insertAgentFunctionConfig">
        REPLACE INTO agent_function_config(agent_no, function_number, one_agent_no, create_time)
        VALUES(#{agentNo}, #{functionNumber}, #{oneAgentNo}, NOW())
    </update>

    <delete id="deleteAgentFunction">
        DELETE FROM agent_function_config
        WHERE function_number = #{functionNumber}
        AND agent_no IN 
        <foreach collection="agentList" item="agentNo" separator="," open="(" close=")">
            #{agentNo}
        </foreach>
    </delete>

    <select id="countAgentFunction" resultType="boolean">
        select count(1) FROM agent_function_config
        WHERE function_number = #{functionNumber}
        AND agent_no = #{agentNo}
    </select>
    
    <select id="countAgentFunctionManage" resultType="boolean">
        select count(1) FROM agent_function_manage
        WHERE function_number = #{functionNumber}
        AND agent_no = #{agentNo}
    </select>

    <select id="listAgentFunctionConfig" resultType="cn.eeepay.framework.model.AgentInfo">
        SELECT ai.agent_no, ai.agent_name FROM agent_function_config afc
            JOIN agent_info ai ON afc.agent_no = ai.agent_no and afc.one_agent_no = ai.one_level_id
        WHERE afc.one_agent_no = #{oneAgentNo}
              AND afc.function_number= #{functionNumber}
              AND ai.agent_level = 2
        <if test="agentInfo.agentNo != null and agentInfo.agentNo != ''">
            AND ai.agent_no = #{agentInfo.agentNo }
        </if>
        <if test="agentInfo.agentName != null and agentInfo.agentName != ''">
            AND position(#{agentInfo.agentName} IN ai.agent_name)
        </if>
    </select>

    <select id="findAgentInfoByAgentNo" resultType="cn.eeepay.framework.model.AgentInfo">
        SELECT ai.agent_no, ai.agent_name FROM  agent_info ai
        WHERE ai.one_level_id = #{oneAgentNo}
        AND  ai.agent_no = #{agentNo}
    </select>
</mapper>
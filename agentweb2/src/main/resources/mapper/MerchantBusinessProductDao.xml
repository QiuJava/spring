<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.eeepay.framework.dao.MerchantBusinessProductDao" >

    <update id="updateMerchantBusinessProduct">
        UPDATE merchant_business_product
        SET bp_id = #{newBpId},
            item_source = '3',
            auditor_id = '1',
            STATUS = '4',
            last_update_time = CURRENT_TIMESTAMP
        WHERE merchant_no = #{merchantNo}
        AND   bp_id = #{oldBpId}
    </update>

    <select id="listServiceInfoByBpId" resultType="cn.eeepay.framework.model.ServiceInfoBean">
        SELECT si1.service_id,
                bpi.bp_id ,
                CONCAT(IFNULL(si2.service_type, 'S'),si1.service_type) serviceType,
                si1.fixed_rate,
		        si1.fixed_quota
        FROM business_product_info bpi
        LEFT JOIN service_info si1 ON si1.service_id = bpi.service_id
        LEFT JOIN service_info si2 ON si2.link_service = si1.service_id
        WHERE bpi.bp_id = #{bpId}
    </select>

    <update id="updateMerchantService">
        UPDATE merchant_service
        SET bp_id = #{newBpId},
            service_id = #{newServiceId},
            create_date = CURRENT_TIMESTAMP,
            STATUS = 1
        WHERE merchant_no = #{merchantNo}
        AND   service_id = #{oldServiceId}
        AND   bp_id = #{oldBpId}
    </update>
    
    <insert id="bacthInsertServiceQuota" parameterType="java.util.List">
        insert merchant_service_quota
        (
            service_id,
            card_type,
            holidays_mark,
            merchant_no,
            single_day_amount,
            single_count_amount,
            single_daycard_amount,
            single_daycard_count,
            efficient_date,
            useable,
            single_min_amount
        )values
        <foreach collection="quotaList" item="item" separator=",">
            (
                #{item.serviceId},
                #{item.cardType},
                #{item.holidaysMark},
                #{merchantNo},
                #{item.singleDayAmount},
                #{item.singleCountAmount},
                #{item.singleDaycardAmount},
                #{item.singleDaycardCount},
                CURRENT_DATE,
                '1',
                #{item.singleMinAmount}
            )
        </foreach>
    </insert>
    <insert id="bacthInsertServiceRate" parameterType="java.util.List">
        insert INTO merchant_service_rate
        (
            service_id,
            merchant_no,
            holidays_mark,
            card_type,
            rate_type,
            single_num_amount,
            rate,
            capping,
            safe_line,
            efficient_date,
            ladder1_rate,
            ladder1_max,
            ladder2_rate,
            ladder2_max,
            ladder3_rate,
            ladder3_max,
            ladder4_rate,
            ladder4_max,
            useable
        )values
        <foreach collection="rateList" item="bean" separator="," open="" close="">
        (
            #{bean.serviceId},
            #{merchantNo},
            #{bean.holidaysMark},
            #{bean.cardType},
            #{bean.rateType},
            #{bean.singleNumAmount},
            #{bean.rate},
            #{bean.capping},
            #{bean.safeLine},
            CURRENT_DATE,
            #{bean.ladder1Rate},
            #{bean.ladder1Max},
            #{bean.ladder2Rate},
            #{bean.ladder2Max},
            #{bean.ladder3Rate},
            #{bean.ladder3Max},
            #{bean.ladder4Rate},
            #{bean.ladder4Max},
            '1'
        )
        </foreach>
    </insert>
</mapper>